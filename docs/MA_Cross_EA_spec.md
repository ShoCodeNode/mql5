# MA_Cross_EA 仕様書

## 概要
短期移動平均線（ファスト MA）と長期移動平均線（スロー MA）のゴールデンクロス/デッドクロスを利用したトレンドフォロー型エキスパートアドバイザーです。ファスト MA がスロー MA を上抜けた時にロング、下抜けた時にショートのシグナルを生成します。

## 使用インジケータ
- **Moving Average (iMA)**: 2本の SMA（Simple Moving Average）
  - ファスト MA: 短期トレンド判定用
  - スロー MA: 長期トレンド判定用

## パラメータ設定

### トレード制御パラメータ
| パラメータ名 | 型 | デフォルト値 | 説明 |
|-------------|-----|------------|------|
| `inp_FastMAPeriod` | int | 12 | ファスト MA の期間（バー数）|
| `inp_SlowMAPeriod` | int | 24 | スロー MA の期間（バー数）|
| `inp_MAMethod` | ENUM_MA_METHOD | MODE_SMA | 移動平均の計算方法（SMA推奨） |
| `inp_AppliedPrice` | ENUM_APPLIED_PRICE | PRICE_CLOSE | 適用価格（終値推奨） |

### マネーマネジメントパラメータ
| パラメータ名 | 型 | デフォルト値 | 説明 |
|-------------|-----|------------|------|
| `inp_Lot` | double | 0.1 | 1回のトレードロット數 |
| `inp_StopLoss` | uint | 200 | ストップロス（ポイント単位） |
| `inp_TakeProfit` | uint | 400 | テイクプロフィット（ポイント単位） |

### システムパラメータ
| パラメータ名 | 型 | デフォルト値 | 説明 |
|-------------|-----|------------|------|
| `inp_MagicNumber` | long | 20250100 | EA の識別番号（重複禁止） |
| `inp_Slippage` | uint | 10 | スリッページ許容値（ポイント） |
| `inp_MaxSpread` | uint | 50 | 最大許容スプレッド（ポイント） |

## エントリー/エグジット条件

### エントリー信号
#### ゴールデンクロス（ファスト MA > スロー MA）
1. 前足でファスト MA ≤ スロー MA
2. 現足でファスト MA > スロー MA
3. スプレッド ≤ `inp_MaxSpread`
4. **アクション**: **ロング（BUY）ポジション オープン**

#### デッドクロス（ファスト MA < スロー MA）
1. 前足でファスト MA ≥ スロー MA
2. 現足でファスト MA < スロー MA
3. スプレッド ≤ `inp_MaxSpread`
4. **アクション**: **ショート（SELL）ポジション オープン**

### エグジット条件
- **ストップロス**: エントリー価格から `inp_StopLoss` ポイント逆方向
- **テイクプロフィット**: エントリー価格から `inp_TakeProfit` ポイント順方向
- ※逆シグナルでのエグジットは実装しない（SL/TP優先）

## リスク管理

### マジックナンバー
- 外部パラメータ `inp_MagicNumber` で指定可能
- デフォルト値: `20250100`（MA_Cross_EA 専用）
- 本EAが発注した注文の識別に使用
- 同一チャートで複数EAを稼動させる場合は値を変更すること

### ロット計算
- **固定ロット**: `inp_Lot` で指定された値をそのまま使用
- シンボル仕様により自動調整（最小/最大ロット、ロット単位に対応）

### スプレッド管理
- トレード実行前に現在スプレッドをチェック
- `inp_MaxSpread` を超える場合は取引を中止
- 流動性が低い時間帯（朝方など）でのスリッピング防止

### チャート/シンボル
- `_Symbol`: 現在のシンボルで自動的に取引
- `_Period`: 現在のタイムフレームで MA を計算
- 複数時間足での運用にも対応

## イベント駆動フロー

### OnInit()
1. トレード設定の初期化
   - `CTrade.SetExpertMagicNumber()`: マジックナンバー設定
   - `CTrade.SetDeviationInPoints()`: スリッページ許容値設定
2. インジケータハンドル作成
   - ファスト MA ハンドル作成（失敗時は `INIT_FAILED`）
   - スロー MA ハンドル作成（失敗時は `INIT_FAILED`）
3. バッファ初期化
   - 前足の MA 値キャッシュ（クロス判定用）

### OnTick()
1. **新足判定**  
   - 前足シーケンスから新足判定（`m_bar_time`）
   
2. **インジケータ値取得**  
   - `CopyBuffer()` で直近 2 本の MA 値を取得
   
3.  **シグナル判定**  
   - 前足と現足の MA 値をを比較
   - クロスフラグ（ゴールデン/デッド）セット
   
4. **リスク管理チェック**  
   - スプレッド確認
   - 既存ポジション確認
   
5. **シグナル実行**  
   - `CTrade.Buy()` / `CTrade.Sell()`で注文
   - 結果ログ出力

### OnDeinit()
1. インジケータハンドル解放（`IndicatorRelease()`）
2. ログ出力（終了理由等）

## バックテスト時の推奨設定
- **期間**: 1 年以上
- **ティック生成**: "Every tick" または "Control points"
- **ロット**: 固定 0.1 ～ 0.5（口座レバレッジに応じて調整）
- **スプレッド**: リアル相場相当（2-5 pips 程度）
- **スリッページ**: 3-5 pips（リアル相場を想定）

## 既知の制限・今後の拡張
- 複数ポジションを同時にオープンしない（1 ポジション制限）
- トレーリングストップは未実装
- インジケータの複合シグナル（他インジケータとの組み合わせ）は未実装
- 経済指標発表前のトレード制限機能は未実装

---

## 変更履歴

| 日付 | 修正内容 | 修正理由 |
|-----|---------|---------|
| 2025-01-15 | 初版作成 | MA_Cross_EA の開発開始 |